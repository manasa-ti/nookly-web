name: Deploy Flutter Web to GitHub Pages

on:
  push:
    branches:
      - main        # Deploy production on main branch
      - staging     # Deploy staging on staging branch
      - develop     # Deploy development on develop branch
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      force:
        description: 'Force deployment (skip protection rules)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Determine environment based on branch or manual input
    env:
      ENV_NAME: ${{ 
        github.event.inputs.environment != '' && github.event.inputs.environment || 
        (github.ref == 'refs/heads/main' && 'production' || 
         github.ref == 'refs/heads/staging' && 'staging' || 
         'development') 
      }}
    
    # Use GitHub Environment for protection rules and secrets
    environment: ${{ env.ENV_NAME }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build Flutter Web
        env:
          # Map environment name to dart-define value
          DART_ENV: ${{ 
            env.ENV_NAME == 'production' && 'production' || 
            env.ENV_NAME == 'staging' && 'staging' || 
            'development' 
          }}
        run: |
          echo "üî® Building for environment: $DART_ENV"
          echo "üì¶ Using GitHub Environment: ${{ env.ENV_NAME }}"
          
          # Build command with all required dart-define flags
          # Note: Staging uses dev Firebase configs (as per firebase_options.dart)
          flutter build web --release \
            --dart-define=ENVIRONMENT=$DART_ENV \
            --dart-define=HMS_APP_ID=${{ secrets.HMS_APP_ID }} \
            --dart-define=HMS_AUTH_TOKEN=${{ secrets.HMS_AUTH_TOKEN }} \
            --dart-define=FIREBASE_WEB_DEV_API_KEY=${{ secrets.FIREBASE_WEB_DEV_API_KEY }} \
            --dart-define=FIREBASE_WEB_DEV_APP_ID=${{ secrets.FIREBASE_WEB_DEV_APP_ID }} \
            --dart-define=FIREBASE_WEB_DEV_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_WEB_DEV_MESSAGING_SENDER_ID }} \
            --dart-define=FIREBASE_WEB_DEV_PROJECT_ID=${{ secrets.FIREBASE_WEB_DEV_PROJECT_ID }} \
            --dart-define=FIREBASE_WEB_DEV_AUTH_DOMAIN=${{ secrets.FIREBASE_WEB_DEV_AUTH_DOMAIN }} \
            --dart-define=FIREBASE_WEB_DEV_STORAGE_BUCKET=${{ secrets.FIREBASE_WEB_DEV_STORAGE_BUCKET }} \
            --dart-define=FIREBASE_WEB_DEV_MEASUREMENT_ID=${{ secrets.FIREBASE_WEB_DEV_MEASUREMENT_ID }} \
            --dart-define=FIREBASE_WEB_PROD_API_KEY=${{ secrets.FIREBASE_WEB_PROD_API_KEY }} \
            --dart-define=FIREBASE_WEB_PROD_APP_ID=${{ secrets.FIREBASE_WEB_PROD_APP_ID }} \
            --dart-define=FIREBASE_WEB_PROD_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_WEB_PROD_MESSAGING_SENDER_ID }} \
            --dart-define=FIREBASE_WEB_PROD_PROJECT_ID=${{ secrets.FIREBASE_WEB_PROD_PROJECT_ID }} \
            --dart-define=FIREBASE_WEB_PROD_AUTH_DOMAIN=${{ secrets.FIREBASE_WEB_PROD_AUTH_DOMAIN }} \
            --dart-define=FIREBASE_WEB_PROD_STORAGE_BUCKET=${{ secrets.FIREBASE_WEB_PROD_STORAGE_BUCKET }} \
            --dart-define=FIREBASE_WEB_PROD_MEASUREMENT_ID=${{ secrets.FIREBASE_WEB_PROD_MEASUREMENT_ID }} \
            --dart-define=GOOGLE_SIGN_IN_WEB_CLIENT_ID=${{ secrets.GOOGLE_SIGN_IN_WEB_CLIENT_ID }} \
            --dart-define=GOOGLE_SIGN_IN_ANDROID_CLIENT_ID=${{ secrets.GOOGLE_SIGN_IN_ANDROID_CLIENT_ID }} \
            --dart-define=GOOGLE_SIGN_IN_IOS_CLIENT_ID=${{ secrets.GOOGLE_SIGN_IN_IOS_CLIENT_ID }}
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
          # Optional: Use a different branch for GitHub Pages
          # publish_branch: gh-pages
          # Optional: Keep deployment history
          keep_files: false
          # Optional: Add commit message
          commit_message: 'Deploy ${{ env.ENV_NAME }} environment - ${{ github.sha }}'
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: web-build-${{ env.ENV_NAME }}
          path: build/web
          retention-days: 7
      
      - name: Build Summary
        run: |
          echo "‚úÖ Build completed successfully!"
          echo "üì¶ Environment: ${{ env.ENV_NAME }}"
          echo "üåê Deployment: ${{ github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' && 'Deployed to GitHub Pages' || 'Artifact only' }}"

